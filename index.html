<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Electrical Diagram</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/svg2pdf.js/1.3.4/svg2pdf.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            overflow: hidden;
            font-size: 13px;
        }

        body,
        html {
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* 🔥 Prevent page scrolling */
        }

        .container {
            width: 100vw;
            height: 100vh;
            overflow: hidden !important;
            position: relative;
        }

        svg {
            border: 1px solid #ddd;
            background: white;
            cursor: grab;
        }

        .node {
            cursor: pointer;
        }

         .line {
    stroke-width: 2px;
    transition: stroke-width 0.2s ease-in-out;
}

.line:hover {
    stroke-width: 4px;
}

        .control-btn {
            position: absolute;
            background: #f00;
            color: white;
            border: none;
            padding: 5px;
            cursor: pointer;
            display: none;
        }



.color-container {
    position: relative;
    display: inline-block;
}

.tooltip {
    visibility: hidden;
    background-color: black;
    color: #fff;
    text-align: center;
    padding: 5px;
    border-radius: 4px;
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    white-space: nowrap;
    font-size: 12px;
    z-index: 2;
}

.color-container:hover .tooltip {
    visibility: visible;
}
    </style>
</head>

<body>
    
    <div class="container">

        <button id="menuBtn" style="position: fixed; top: 15px; left: 34px; z-index: 1000;">Symbol</button>
        <button id="addTextBox" style="position: fixed; top: 15px; left: 100px; z-index: 1000;">Text Box</button>
        <button id="addNetworkBtn" style="position: fixed; top: 15px; left: 172px; z-index: 1000;">New
            Network</button>
        <button id="addSignatureBtn" style="position: fixed; top: 15px; left: 272px; z-index: 1000;">Signature</button>
        <input type="file" id="signatureInput" accept="image/png" style="display: none;">
        <button id="drawRoadBtn" style="position: fixed; top: 15px; left: 461px; z-index: 1000;">Draw Road</button>

        <div id="menuList" 
        style="display: none; position: absolute; top: 40px; left: 10px; background: white; padding: 10px; border: 1px solid #ddd; width: 160px; flex-wrap: wrap; gap: 5px 5px; row-gap: 5px;">

            <button class="symbolBtn" data-symbol="🌳">🌳</button>
            <button class="symbolBtn" data-symbol="🌴">🌴</button>
            <button class="symbolBtn" data-symbol="🕉️">🕉️</button>
            <button class="symbolBtn" data-symbol="🕌">🕌</button>
            <button class="symbolBtn" data-symbol="🏫">🏫</button>
            <button class="symbolBtn" data-symbol="🏢">🏢</button>
            <button class="symbolBtn" data-symbol="🐟">🐟</button>
            <button class="symbolBtn" data-symbol="🏁">🏁</button>
            <button class="symbolBtn" data-symbol="💡">💡</button>
            <button class="symbolBtn" data-symbol="🏡">🏡</button>
            <button class="symbolBtn" data-symbol="🛖">🛖</button>
            <button class="symbolBtn" data-symbol="❌">❌</button>
            <button class="symbolBtn" data-symbol="✅">✅</button>
            <button class="symbolBtn" data-symbol="⭕">⭕</button>
            <button class="symbolBtn" data-symbol="🔴">🔴</button>
            <button class="symbolBtn" data-symbol="🚫">🚫</utton>
            <button class="symbolBtn" data-symbol="👷">👷</button>
        </div>
        <div id="editableTitle" contenteditable="true" 
     style="position: absolute; top: 50px; left: 50%; transform: translateX(-50%); 
            font-size: 20px; font-weight: bold; text-align: center; cursor: text;
            z-index: 1000;">
    Enter Title Here
</div>
        <svg id="diagram" width="2000" height="2000"></svg>
    </div>
    <button id="addNodeBtn" class="control-btn">Add</button>
    <!-- Add this div for the Summary Table -->
    <div id="summaryTable"
    
    style="position: absolute; bottom: 60px; right: 60px; background: none; padding: 10px; cursor: grab; display: inline-block; z-index: 1;">
 
    <h3 id="summaryHeader" style="margin: 5; cursor: grab;">Summary</h3>
    <table style="border-collapse: collapse; text-align: left; width: auto;">

            <th>Item⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀</th>
            <th>Quantity</th>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
onmouseout="this.querySelector('.hide-btn').style.display='none';">
<td contenteditable="true">Item-1</td>
<td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
            onmouseout="this.querySelector('.hide-btn').style.display='none';">
            <td contenteditable="true">Item-1</td>
            <td contenteditable="true">Qty-1</td>
            <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
        </tr>
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td contenteditable="true">Item-1</td>
                <td contenteditable="true">Qty-1</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
        </tr>
    
        <tr style="border-bottom: 1px solid gray;">
            <tr class="summary-rown" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td contenteditable="true">Item-1</td>
                <td contenteditable="true">Qty-1</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
        </tr>
        <tr style="border-bottom: 1px solid gray;">

    </table>
</div>

    
    <button id="summaryBtn" style="position: absolute; top: 15px; right: 520px; z-index: 1000; 
    background: rgba(255, 255, 0, 0); color: black; border: none; 
    padding: 0px; cursor: pointer; font-size: 19px;">
    Ⓢ
    <button id="legendBtn" style="position: absolute; top: 15px; right: 545px; z-index: 1000; 
    background: rgba(255, 255, 0, 0); color: black; border: none; 
    padding: 0px; cursor: pointer; font-size: 19px;">
    Ⓛ
</button>

    <button id="infoBtn" style="position: absolute; top: 15px; right: 400px; z-index: 1000; 
    background: rgba(255, 255, 0, 0); color: rgb(249, 4, 4); border: none; 
    padding: 0px; cursor: pointer; font-size: 19px; font-weight: bold;">
    ⓘ</button>
    <button id="importJsonBtn" style="position: absolute; top: 15px; right: 302px; z-index: 1000;  color: rgb(255, 34, 9);">Import SLD</button>
<input type="file" id="importJsonInput" style="display: none;">
 <button id="exportJsonBtn" style="position: absolute; top: 15px; right: 210px; z-index: 1000; color: rgb(0, 210, 88);" title="Exports only nodes, line & symbols.">
        Export SLD </button>
    <button id="resetBtn" style="position: absolute; top: 15px; right: 152px; z-index: 1000;">Reset</button>
    <button id="savePngBtn" style="position: absolute; top: 15px; right: 90px; z-index: 1000;">⤓ PNG</button>
    <button id="savePdfBtn" style="position: absolute; top: 15px; right: 30px; z-index: 1000;">⤓ PDF</button>
    <script>
        document.getElementById("resetBtn").addEventListener("click", () => {
            location.reload();
        });
        document.getElementById("addNetworkBtn").addEventListener("click", function () {
            // Default position for the new node
            const newNode = {
                id: nodes.length + 1,
                x: 300, // Adjust as needed for blank space
                y: 300, // Adjust as needed for blank space
                text: "8m",
                color: "gray"
            };

            nodes.push(newNode);
            drawDiagram(); // Redraw to reflect changes
        });

    </script>

    <button id="deleteNodeBtn" class="control-btn">Delete</button>

    <script>
        const svg = d3.select("#diagram");
        const container = svg.append("g");

        // Enable zoom and pan
        const zoom = d3.zoom()
            .scaleExtent([0.5, 3]) // Min and max zoom levels
            .on("zoom", (event) => {
                container.attr("transform", event.transform);
            });


        svg.call(zoom);
        svg.on("dblclick.zoom", null);


        const addNodeBtn = document.getElementById("addNodeBtn");
        const deleteNodeBtn = document.getElementById("deleteNodeBtn");
        let selectedNode = null;

        let nodes = [
            { id: 1, x: 500, y: 200, text: "DP", color: "gray" },
            { id: 2, x: 600, y: 250, text: "TP", color: "gray" },
            { id: 3, x: 800, y: 270, text: "8m", color: "gray" },
            { id: 4, x: 1000, y: 200, text: "9m", color: "gray" },
            { id: 5, x: 700, y: 600, text: "DTR", shape: "rect", color: "gray" }
        ];
        let links = [
            { source: 1, target: 2, color: "black", text: "label", x: 300, y: 100, rotate: 0 },
            { source: 2, target: 3, color: "black", text: "label", x: 500, y: 100, rotate: 0 },
            { source: 3, target: 4, color: "black", text: "label", x: 700, y: 100, rotate: 0 },
            { source: 2, target: 5, color: "black", text: "label", x: 450, y: 250, rotate: 0 }
        ];


        document.getElementById("menuBtn").addEventListener("click", () => {
    const menuList = document.getElementById("menuList");

    if (menuList.style.display === "none" || menuList.style.display === "") {
        menuList.style.display = "flex"; // Show symbols in multiple rows
    } else {
        menuList.style.display = "none"; // Hide when clicked again
    }
});


        svg.on("click", (event) => {
            if (!drawingRoad) return;

            tooltip.style.display = "none"; // Hide "Click to Start" after first click
            document.removeEventListener("mousemove", moveTooltip);

            const transform = d3.zoomTransform(svg.node());
            const [x, y] = transform.invert(d3.pointer(event));

            if (roadSegments.length > 0) {
                const prevPoint = roadSegments[roadSegments.length - 1];

                const line = roadLayer.append("line")
                    .attr("x1", prevPoint.x)
                    .attr("y1", prevPoint.y)
                    .attr("x2", x)
                    .attr("y2", y)
                    .attr("stroke", roadColor)
                    .attr("stroke-width", roadWidth)
                    .attr("stroke-opacity", opacitySlider.value)
                    .attr("stroke-linecap", "round")
                    .attr("stroke-linejoin", "round")
                    .attr("class", "road-line")
                    .on("mouseover", function (event) {
                        showDeleteButton(this, event);
                    })
                    .on("mouseout", () => {
                        hideDeleteButton();
                    });

                roadSegments.push({ x, y, line });
                updateRoadTransparency();
            } else {
                roadSegments.push({ x, y });
            }
        });



        let selectedSymbol = null;

        document.querySelectorAll(".symbolBtn").forEach(button => {
            button.addEventListener("click", (event) => {
                selectedSymbol = event.target.dataset.symbol; // Store only the data-symbol value
            });
        });


        let tooltip = document.createElement("div");
        tooltip.textContent = "Click to insert";
        tooltip.style.position = "absolute";
        tooltip.style.display = "none";
        tooltip.style.background = "yellow";
        tooltip.style.color = "black";
        tooltip.style.padding = "5px";
        tooltip.style.borderRadius = "5px";
        tooltip.style.fontSize = "12px";
        tooltip.style.pointerEvents = "none"; // Prevent interaction
        document.body.appendChild(tooltip);

        document.querySelectorAll(".symbolBtn").forEach(button => {
            button.addEventListener("click", (event) => {
                selectedSymbol = event.target.dataset.symbol;

                // Show tooltip near the cursor
                tooltip.style.display = "block";
                document.addEventListener("mousemove", moveTooltip);
            });
        });

        // Function to move tooltip with cursor
        function moveTooltip(event) {
            tooltip.style.left = `${event.pageX + 10}px`;
            tooltip.style.top = `${event.pageY + 10}px`;
        }

        svg.on("click.symbol", (event) => {
            if (!selectedSymbol) return;

            const transform = d3.zoomTransform(svg.node());
            const [x, y] = transform.invert(d3.pointer(event));

            console.log("Placing symbol at:", x, y); // Debugging log

            nodes.push({ id: nodes.length + 1, x, y, text: selectedSymbol, color: "none" });
            drawDiagram();

            // Reset selected symbol after placement
            selectedSymbol = null;
            tooltip.style.display = "none";
            document.removeEventListener("mousemove", moveTooltip);
        });



        function drawDiagram() {
            container.selectAll("*").rem
            container.selectAll(".node, .line, .link-label").remove(); // Remove only nodes, lines, and labels




            let drawingRoad = false;
            let roadColor = "#d2b746";
            let roadWidth = 23;
            let roadSegments = [];
            let deleteTimeout = null;

            const drawRoadBtn = document.getElementById("drawRoadBtn");
            const roadLayer = container.insert("g", ":first-child").attr("id", "roadLayer");


            const opacitySlider = document.createElement("input");
            opacitySlider.type = "range";
            opacitySlider.min = 0.1;
            opacitySlider.max = 1;
            opacitySlider.step = 0.1;
            opacitySlider.style.zIndex = "1000";  // <== Add this line
            opacitySlider.value = 1; // Default transparency
            opacitySlider.style.position = "absolute";
            opacitySlider.style.top = "15px";
            opacitySlider.style.left = "620px";
          //  document.body.appendChild(opacitySlider);


            // Create "Click to Start" tooltip
            const tooltip = document.createElement("div");
            tooltip.textContent = "Click to draw";
            tooltip.style.position = "absolute";
            tooltip.style.display = "none";
            tooltip.style.background = "yellow";
            tooltip.style.color = "black";
            tooltip.style.padding = "5px";
            tooltip.style.borderRadius = "5px";
            tooltip.style.fontSize = "12px";
            tooltip.style.pointerEvents = "none"; // Prevent interaction
            document.body.appendChild(tooltip);




            drawRoadBtn.addEventListener("click", () => {
                drawingRoad = !drawingRoad;
                roadSegments = [];
                drawRoadBtn.style.background = drawingRoad ? "red" : "";
                drawRoadBtn.style.color = drawingRoad ? "white" : "black";
                document.body.style.cursor = drawingRoad ? "crosshair" : "default";
                drawRoadBtn.textContent = drawingRoad ? "Stop Road" : "Draw Road";

                if (drawingRoad) {
                    tooltip.style.display = "block";
                    document.addEventListener("mousemove", moveTooltip);
                } else {
                    tooltip.style.display = "none";
                    tooltip.style.visibility = "hidden";  // ✅ Ensures complete hiding
                    tooltip.style.opacity = "0";  // ✅ Extra safety measure
                    document.removeEventListener("mousemove", moveTooltip);
                }
            });

            // Function to move tooltip with cursor
            function moveTooltip(event) {
                tooltip.style.left = `${event.pageX + 10}px`;
                tooltip.style.top = `${event.pageY + 10}px`;
            }

            const colorPicker = document.createElement("input");
            colorPicker.type = "color";
            colorPicker.value = roadColor;
            colorPicker.style.position = "absolute";
            colorPicker.style.top = "15px";
            colorPicker.style.zIndex = "1000";  // <== Add this line
            colorPicker.style.width = "33px";
            colorPicker.style.height = "22px";
            colorPicker.style.left = "545px";
            document.body.appendChild(colorPicker);

            const widthInput = document.createElement("input");
            widthInput.type = "number";
            widthInput.min = 1;
            widthInput.max = 40;
            widthInput.value = roadWidth;
            widthInput.style.position = "absolute";
            widthInput.style.top = "15px";
            widthInput.style.width = "33px";
            widthInput.style.left = "580px";
            document.body.appendChild(widthInput);

            colorPicker.addEventListener("input", () => {
                roadColor = colorPicker.value;
            });

            widthInput.addEventListener("input", () => {
                roadWidth = parseInt(widthInput.value);
            });

            svg.on("click", (event) => {
                if (!drawingRoad) return;

                tooltip.style.display = "none"; // Hide "Click to Start" after first click
                document.removeEventListener("mousemove", moveTooltip);

                const transform = d3.zoomTransform(svg.node());
                const [x, y] = transform.invert(d3.pointer(event));

                if (roadSegments.length > 0) {
                    const prevPoint = roadSegments[roadSegments.length - 1];

                    const line = roadLayer.append("line") // Append to roadLayer, not container
                        .attr("x1", prevPoint.x)
                        .attr("y1", prevPoint.y)
                        .attr("x2", x)
                        .attr("y2", y)
                        .attr("stroke", roadColor)
                        .attr("stroke-width", roadWidth)
                        .attr("stroke-opacity", opacitySlider.value)
                        .attr("stroke-linecap", "round")
                        .attr("stroke-linejoin", "round")
                        .attr("class", "road-line")
                        .on("mouseover", function (event) {
                            showDeleteButton(this, event);
                        })
                        .on("mouseout", () => {
                            hideDeleteButton();
                        });

                    roadSegments.push({ x, y, line });
                    updateRoadTransparency(); // Check and update transparency for overlapping segments
                } else {
                    roadSegments.push({ x, y });
                }
            });

            container.call(
                d3.drag()
                    .on("start", () => { document.body.style.cursor = "move"; })
                    .on("drag", (event) => { moveRoad(event.dx, event.dy); })
                    .on("end", () => { document.body.style.cursor = "default"; })
            );


            // Function to move entire road while keeping segments connected
            function moveRoad(dx, dy) {
                roadSegments.forEach(segment => {
                    segment.x += dx;
                    segment.y += dy;
                });


                opacitySlider.addEventListener("input", () => {
                    d3.selectAll(".road-line").attr("stroke-opacity", opacitySlider.value);
                });

                roadSegments.forEach((segment, index) => {
                    if (index > 0) {
                        segment.line
                            .attr("x1", roadSegments[index - 1].x)
                            .attr("y1", roadSegments[index - 1].y)
                            .attr("x2", segment.x)
                            .attr("y2", segment.y);
                    }
                });
            }




            // Delete button handling
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "Delete";
            deleteButton.style.position = "absolute";
            deleteButton.style.display = "none";
            deleteButton.style.background = "red";
            deleteButton.style.color = "white";
            deleteButton.style.border = "none";
            deleteButton.style.padding = "5px";
            deleteButton.style.cursor = "pointer";
            document.body.appendChild(deleteButton);

            function showDeleteButton(line, event) {
                deleteButton.style.left = `${event.pageX + 10}px`;
                deleteButton.style.top = `${event.pageY}px`;
                deleteButton.style.display = "block";

                // Clear previous timeout if user hovers again
                if (deleteTimeout) clearTimeout(deleteTimeout);

                deleteButton.onclick = () => {
                    d3.select(line).remove();
                    deleteButton.style.display = "none";
                };
            }

            function hideDeleteButton() {
                deleteTimeout = setTimeout(() => {
                    deleteButton.style.display = "none";
                }, 1500); // Hide after 1.5 seconds
            }


        // Draw links with toggling line type on click
// Define line styles
const lineStyles = [
    { dasharray: "0", crosses: false, wavy: false }, // Solid
    { dasharray: "0", crosses: false, wavy: true },  // Wavy
    { dasharray: "0", crosses: true, wavy: false },  // Solid with crosses (╳)
    { dasharray: "0", crosses: true, wavy: false, symbol: "⊢" }, // Solid with ⑴
    { dasharray: "0", crosses: true, wavy: false, symbol: "⊩" }, // Solid with ⑵
    { dasharray: "0", crosses: true, wavy: false, symbol: "⊪" }  // Solid with ⑶
];


// Function to create/update crosses for a line
function updateCrosses(lineElement) {
    const line = d3.select(lineElement);
    const data = line.datum();
    const parent = d3.select(lineElement.parentNode);
    const style = lineStyles[data.styleIndex];

    // Get line coordinates
    const x1 = parseFloat(line.attr("x1"));
    const y1 = parseFloat(line.attr("y1"));
    const x2 = parseFloat(line.attr("x2"));
    const y2 = parseFloat(line.attr("y2"));

    // Calculate angle and length
    const angle = Math.atan2(y2 - y1, x2 - x1) * 180 / Math.PI;
    const length = Math.sqrt(Math.pow(x2 - x1, 2) + Math.pow(y2 - y1, 2));

    // Calculate cross positions
    const spacing = 30;
    const numCrosses = Math.floor(length / spacing);
    const crosses = [];

    for (let i = 1; i <= numCrosses; i++) {
        const t = i / (numCrosses + 1);
        crosses.push({
            x: x1 + (x2 - x1) * t,
            y: y1 + (y2 - y1) * t,
            angle: angle,
            symbol: style.symbol || "☓"  // Use ⑴, ⑵, ⑶, or default to ╳
        });
    }

    // Select or create cross group
    let crossGroup = parent.select(`.crosses-${data.source}-${data.target}`);
    if (crossGroup.empty()) {
        crossGroup = parent.append("g")
            .attr("class", `crosses-${data.source}-${data.target}`);
    }

    // Update crosses
    const crossElements = crossGroup.selectAll(".cross")
        .data(crosses);

    crossElements.exit().remove();

    const crossEnter = crossElements.enter()
        .append("g")
        .attr("class", "cross");

    crossEnter.append("text")
        .attr("class", "cross-symbol")
        .attr("text-anchor", "middle")
        .attr("alignment-baseline", "middle")
        .attr("font-size", "16px")
        .attr("fill", line.attr("stroke"))
        .text(d => d.symbol);

    // Update positions
    const allCrosses = crossElements.merge(crossEnter);
    allCrosses.attr("transform", d => `translate(${d.x},${d.y}) rotate(${d.angle})`);
}


// Function to create/update wavy line
function updateWavyLine(lineElement) {
    const line = d3.select(lineElement);
    const data = line.datum();
    const parent = d3.select(lineElement.parentNode);

    // Get line coordinates
    const x1 = parseFloat(line.attr("x1"));
    const y1 = parseFloat(line.attr("y1"));
    const x2 = parseFloat(line.attr("x2"));
    const y2 = parseFloat(line.attr("y2"));

    // Calculate length and angle
    const dx = x2 - x1;
    const dy = y2 - y1;
    const length = Math.sqrt(dx * dx + dy * dy);
    const angle = Math.atan2(dy, dx) * 180 / Math.PI;
    
    // Wavy line parameters
    const amplitude = 3;
    const frequency = 20;
    const numPoints = Math.ceil(length / 3); // 5 pixels between points

    // Generate points for wavy path
    const points = [];
    for (let i = 0; i <= numPoints; i++) {
        const t = i / numPoints;
        const x = t * length;
        const y = amplitude * Math.sin((x / frequency) * 2 * Math.PI);
        points.push([x, y]);
    }

 // Select or create wavy path group
 let wavyGroup = parent.select(`.wavy-${data.source}-${data.target}`);
    if (wavyGroup.empty()) {
        wavyGroup = parent.insert("g", ":first-child") // Insert at the beginning (before nodes)
            .attr("class", `wavy-${data.source}-${data.target}`);
    }

    // Create path string
    const pathData = d3.line()(points);

    // Update or create path
    let wavyPath = wavyGroup.select("path");
    if (wavyPath.empty()) {
        wavyPath = wavyGroup.append("path")
            .attr("class", "wavy-path")
            .attr("stroke", line.attr("stroke"))
            .attr("stroke-width", 2)
            .attr("fill", "none")
            .style("cursor", "pointer")
            .on("click", function() {
                // Trigger the same click handler as the original line
                const originalLine = d3.select(`line.line[data-source="${data.source}"][data-target="${data.target}"]`);
                const event = new Event('click');
                originalLine.node().dispatchEvent(event);
            });
    } else {
        // Update existing path
        wavyPath
            .attr("stroke", line.attr("stroke"))
            .attr("stroke-width", 2)
            .attr("fill", "none");
    }

    // Position and rotate the path
    wavyPath.attr("d", pathData)
        .attr("transform", `translate(${x1},${y1}) rotate(${angle})`);

    // Ensure the wavy line is behind the nodes by reordering elements
    wavyGroup.lower();

    // Hide the original straight line but keep it for data binding
    line.style("opacity", "0");
}



// Update line and its crosses/waves
function updateLineAndCrosses(lineElement) {
    const line = d3.select(lineElement);
    const data = line.datum();

    // Update line position
    line
        .attr("x1", d => nodes.find(n => n.id === d.source).x)
        .attr("y1", d => nodes.find(n => n.id === d.source).y)
        .attr("x2", d => nodes.find(n => n.id === d.target).x)
        .attr("y2", d => nodes.find(n => n.id === d.target).y)
        // Add data attributes to help identify this line later
        .attr("data-source", d => d.source)
        .attr("data-target", d => d.target);

    // Update crosses if style includes them
    if (lineStyles[data.styleIndex].crosses) {
        updateCrosses(lineElement);
    }

    // Update wavy line if style is wavy
    if (lineStyles[data.styleIndex].wavy) {
        updateWavyLine(lineElement);
    } else {
        // Show the straight line when not wavy
        line.style("opacity", "1");
        // Remove wavy path if exists
        const parent = d3.select(lineElement.parentNode);
        parent.select(`.wavy-${data.source}-${data.target}`).remove();
    }
}

// Create and update lines
container.selectAll(".line")
    .data(links)
    .enter()
    .append("line")
    .attr("class", "line")
    .attr("stroke", d => d.color || "black")
    .attr("stroke-width", 2)
    .attr("x1", d => nodes.find(n => n.id === d.source).x)
    .attr("y1", d => nodes.find(n => n.id === d.source).y)
    .attr("x2", d => nodes.find(n => n.id === d.target).x)
    .attr("y2", d => nodes.find(n => n.id === d.target).y)
    .attr("data-source", d => d.source) // Add data attributes to help identify this line later
    .attr("data-target", d => d.target)
    .each(function (d) {
        if (d.styleIndex === undefined) d.styleIndex = 0;
        const line = d3.select(this);
        line.attr("stroke-dasharray", lineStyles[d.styleIndex].dasharray);
        
        if (lineStyles[d.styleIndex].crosses) {
            updateCrosses(this);
        }
        
        if (lineStyles[d.styleIndex].wavy) {
            updateWavyLine(this);
        }
    })
    .style("cursor", "pointer")
    .on("click", function (event, d) {
        // Remove existing crosses and wavy lines
        const parent = d3.select(this.parentNode);
        parent.select(`.crosses-${d.source}-${d.target}`).remove();
        parent.select(`.wavy-${d.source}-${d.target}`).remove();

        // Show the line (in case it was hidden by wavy style)
        d3.select(this).style("opacity", "1");

        // Update style
        d.styleIndex = (d.styleIndex + 1) % lineStyles.length;

        // Apply new style
        const line = d3.select(this);
        line.attr("stroke-dasharray", lineStyles[d.styleIndex].dasharray);

        // Add crosses if needed
        if (lineStyles[d.styleIndex].crosses) {
            updateCrosses(this);
        }
        
        // Add wavy line if needed
        if (lineStyles[d.styleIndex].wavy) {
            updateWavyLine(this);
        }
    })

                .on("dblclick", function (event, d) {
                    // Create a color input element
                    const colorPicker = document.createElement("input");
                    colorPicker.type = "color";
                    colorPicker.style.position = "absolute";
                    colorPicker.style.left = `${event.pageX}px`;
                    colorPicker.style.top = `${event.pageY}px`;
                    colorPicker.value = d.color || "#000000"; // Set current color or default to black

                    document.body.appendChild(colorPicker);
                    colorPicker.focus();

                    // Update color on selection
                    colorPicker.addEventListener("input", () => {
    d.color = colorPicker.value;
    const line = d3.select(event.target); // Use event.target to ensure correct element selection
    line.attr("stroke", d.color);

    const parent = d3.select(line.node().parentNode);

    // Update crosses color
    parent.select(`.crosses-${d.source}-${d.target}`)
        .selectAll(".cross-symbol") // Update text elements, not non-existent "cross-line"
        .attr("fill", d.color);

    // Update wavy line color if exists
    parent.select(`.wavy-${d.source}-${d.target}`)
        .select("path")
        .attr("stroke", d.color);
});

                    // Remove color picker when focus is lost
                    colorPicker.addEventListener("blur", () => {
                        document.body.removeChild(colorPicker);
                    });

                    // Prevent event from bubbling
                    event.stopPropagation();
                });


            // Drag behavior
            const drag = d3.drag()
                .on("drag", function (event, d) {
                    // Update node position
                    d.x = event.x;
                    d.y = event.y;
                    d3.select(this)
                        .attr("cx", d.x)
                        .attr("cy", d.y);

                    // Update connected lines and crosses
                    container.selectAll(".line")
                        .filter(line => line.source === d.id || line.target === d.id)
                        .each(function () {
                            updateLineAndCrosses(this);
                        });
                });


            // Apply drag behavior to nodes
            container.selectAll(".node")
                .call(drag)

                .on("dblclick", (event, d) => {
                    // Create a color input element
                    const colorPicker = document.createElement("input");
                    colorPicker.type = "color";
                    colorPicker.style.position = "absolute";
                    colorPicker.style.left = `${event.pageX}px`;
                    colorPicker.style.top = `${event.pageY}px`;
                    colorPicker.value = d.color; // Set current color

                    document.body.appendChild(colorPicker);
                    colorPicker.focus();

                    // Update color on selection
                    colorPicker.addEventListener("input", () => {
                        d.color = colorPicker.value;
                        drawDiagram();
                    });

                    // Remove color picker when focus is lost
                    colorPicker.addEventListener("blur", () => {
                        document.body.removeChild(colorPicker);
                    });
                });


            // Draw labels for links
            const linkLabels = container.selectAll(".link-label").data(links).enter()
                .append("g") // Group for text + transform
                .attr("class", "link-label")
                .each(function (d) {
                    const x1 = nodes.find(n => n.id === d.source).x;
                    const y1 = nodes.find(n => n.id === d.source).y;
                    const x2 = nodes.find(n => n.id === d.target).x;
                    const y2 = nodes.find(n => n.id === d.target).y;

                    // Default position & rotation
                    d.x = (x1 + x2) / 2;
                    d.y = (y1 + y2) / 2;
                    d.rotate = Math.atan2(y2 - y1, x2 - x1) * (180 / Math.PI);

                    d3.select(this)
                        .attr("transform", `translate(${d.x},${d.y}) rotate(${d.rotate})`);
                });

            // Add editable text inside the label group
            linkLabels.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", -5)
                .text(d => d.text || "Label") // Default label text
                .attr("fill", "black")
                .on("click", (event, d) => {
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = d.text || "";
                    input.style.position = "absolute";
                    input.style.left = `${event.pageX}px`;
                    input.style.top = `${event.pageY}px`;
                    document.body.appendChild(input);
                    input.focus();
                    input.addEventListener("blur", () => {
                        d.text = input.value;
                        document.body.removeChild(input);
                        drawDiagram();
                    });
                });


            // Draw labels for links
            container.selectAll(".link-label").data(links).enter()
                .append("text")
                .attr("class", "link-label")
                .attr("x", d => (nodes.find(n => n.id === d.source).x + nodes.find(n => n.id === d.target).x) / 2)
                .attr("y", d => (nodes.find(n => n.id === d.source).y + nodes.find(n => n.id === d.target).y) / 2 - 5)
                .attr("text-anchor", "middle")
                .attr("fill", "blue")
                .text(d => d.text || "Label") // Default label
                .on("click", (event, d) => {
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = d.text || "";
                    input.style.position = "absolute";
                    input.style.left = `${event.pageX}px`;
                    input.style.top = `${event.pageY}px`;
                    document.body.appendChild(input);
                    input.focus();
                    input.addEventListener("blur", () => {
                        d.text = input.value; // Save the new label
                        document.body.removeChild(input);
                        drawDiagram();
                    });
                });

            tooltip.style.display = "none"; // Hide "Click to Start" after first click
            document.removeEventListener("mousemove", moveTooltip);

            // Draw nodes
            const nodeElements = container.selectAll(".node").data(nodes).enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`)
                .call(d3.drag()
                    .on("drag", (event, d) => {
                        d.x = event.x; d.y = event.y;
                        drawDiagram();

                    })
                )
                .on("click", (event, d) => {
                    selectedNode = d;
                    positionButtons(event.pageX, event.pageY, d);
                    setTimeout(hideButtons, 1500);
                })

                .on("dblclick", (event, d) => {
                    // Create a color input element
                    const colorPicker = document.createElement("input");
                    colorPicker.type = "color";
                    colorPicker.style.position = "absolute";
                    colorPicker.style.left = `${event.pageX}px`;
                    colorPicker.style.top = `${event.pageY}px`;
                    colorPicker.value = d.color; // Set current color

                    document.body.appendChild(colorPicker);
                    colorPicker.focus();

                    // Update color on selection
                    colorPicker.addEventListener("input", () => {
                        d.color = colorPicker.value;
                        drawDiagram();
                    });

                    // Remove color picker when focus is lost
                    colorPicker.addEventListener("blur", () => {
                        document.body.removeChild(colorPicker);
                    });
                });

            nodeElements.append("circle")
    .attr("r", d => d.size || 20) // Maintain size after resizing
                .attr("fill", d => d.text.match(/[\uD800-\uDFFF]/) ? "none" : d.color) // Transparent for symbols
                .attr("stroke", "none");

                let handle = nodeElements.filter(d => !d.text.match(/\p{Extended_Pictographic}/u))
    .append("rect")
    .attr("class", "resize-handle")
    .attr("width", 10).attr("height", 10)
    .attr("fill", "blue")
    .style("cursor", "se-resize")
    .style("display", "none"); // Hidden by default

nodeElements.each(function (d) {
    let nodeGroup = d3.select(this);
    let hideTimeout;
    
    nodeGroup.on("mouseover", function () {
        if (!d.text.match(/\p{Extended_Pictographic}/u)) {
            clearTimeout(hideTimeout); // Prevent premature hiding
            nodeGroup.select(".resize-handle").style("display", "block");
        }
    }).on("mouseleave", function () {
        hideTimeout = setTimeout(() => {
            nodeGroup.select(".resize-handle").style("display", "none");
        }, 500); // Keep visible for 0.5 seconds after moving away
    });

    nodeGroup.select(".resize-handle")
        .attr("x", d.size ? d.size - 5 : 15)
        .attr("y", d.size ? d.size - 5 : 15); // Adjust handle position initially
});

handle.call(d3.drag()
    .on("start", function () {
        clearTimeout(hideTimeout); // Keep handle visible while dragging
    })
    .on("drag", function (event, d) {
        let newSize = Math.max(10, event.x - d.x);
        d.size = newSize;
        d3.select(this.parentNode).select("circle").attr("r", newSize);
        d3.select(this).attr("x", newSize - 5).attr("y", newSize - 5); // Adjust handle position dynamically
    })
    .on("end", function () {
        hideTimeout = setTimeout(() => {
            d3.select(this.parentNode).select(".resize-handle").style("display", "none");
        }, 500); // Hide after 0.5 seconds when dragging stops
    })
);

            // Add labels to nodes
            nodeElements.append("g") // Group the text and the background rect
                .each(function (d) {
                    // Set label to null only for symbols (emoji-like characters)
                    if (d.text.match(/[\uD800-\uDFFF]/) && !d.label) {
    if (d.text === "❌") {  
        d.label = ""; // 🔥 Remove label for the red cross
    } else {
        d.label = null; // Keep other symbols label-free
    }
} else if (!d.label) {
    d.label = "E,S"; // Restore default label only for normal nodes
}

                    // Create the text element
                    const textElement = d3.select(this).append("text")
                        .attr("text-anchor", "middle")
                        .attr("dy", 35) // Position below the circle
                        .text(d => (d.text === "❌" || d.text === "✅"|| d.text === "⭕"|| d.text === "⚠️" || d.text === "⛔"  ? "" : d.label || "")) // 🔥 Exclude label for red cross
                        .attr("fill", "black") // Set text color
                        .style("font-size", "13px"); // Set font style


                    // Get the bounding box of the text to size the rectangle
                    const bbox = textElement.node().getBBox();

                    // Create a rectangle behind the text to simulate a background
                    d3.select(this).insert("rect", "text") // Insert the rect behind the text
                        .attr("x", bbox.x - 2) // Adjust to center the background around the text
                        .attr("y", bbox.y - 2) // Adjust to position the background around the text
                        .attr("width", bbox.width + 4) // Set width based on the text size
                        .attr("height", bbox.height + 4) // Set height based on the text size
                        .attr("fill", "white"); // Set background color without border


                    // Handle click event to edit the label
                    textElement.on("click", (event, d) => {
                        const input = document.createElement("input");
                        input.type = "text";
                        input.value = d.label || "E,S"; // Start with the existing label or "E,S"
                        input.style.position = "absolute";
                        input.style.left = `${event.pageX}px`;
                        input.style.top = `${event.pageY + 30}px`; // Position below the text
                        input.style.fontStyle = "italic"; // Apply italic style to the input field
                        input.style.backgroundColor = "white"; // Set input background color to white
                        document.body.appendChild(input);
                        input.focus();

                        input.addEventListener("blur", () => {
                            // Update d.label only if the input is not empty
                            const newValue = input.value.trim();
                            if (newValue !== "") {
                                d.label = newValue; // Only update the label if the input is not empty
                            } else {
                                d.label = null; // Set label to null (or remove it) if the input is empty
                            }
                            document.body.removeChild(input);
                            drawDiagram(); // Re-render the diagram
                        });
                    });
                });

            nodeElements.append("text")
                .attr("text-anchor", "middle")
                .attr("dy", "0.35em")
                .attr("font-size", d => isSymbol(d.text) ? "30px" : "16px") // Bigger size for symbols
                .text(d => d.text)
                .attr("fill", "white")


                .on("click", (event, d) => {
                    const input = document.createElement("input");
                    input.type = "text";
                    input.value = d.text;
                    input.style.position = "absolute";
                    input.style.left = `${event.pageX}px`;
                    input.style.top = `${event.pageY}px`;
                    document.body.appendChild(input);
                    input.focus();
                    input.addEventListener("blur", () => {
                        d.text = input.value;
                        document.body.removeChild(input);
                        drawDiagram();
                    });
                });

            // Function to check if the text is a symbol (emoji or special character)
            function isSymbol(text) {
                if (!text) return false; // Handle empty text cases
                const codePoint = text.codePointAt(0); // Get the Unicode value of the first character
                return (
                    (codePoint >= 0x1F300 && codePoint <= 0x1F6FF) || // Emojis (e.g., 🌳, 🚀, ⚡)
                    (codePoint >= 0x2700 && codePoint <= 0x27BF) ||  // Dingbats (e.g., ❌, ➕, ➖)
                    /*  (codePoint >= 0x2600 && codePoint <= 0x26FF) ||  // Misc Symbols (e.g., ☀, ☎)*/
                    (codePoint >= 0x2B50 && codePoint <= 0x2BFF)     // Additional symbols (e.g., ⭐)
                );
            }
        }

        function positionButtons(x, y, node) {
            if (node.text.match(/[\uD800-\uDFFF]/)) {
                deleteNodeBtn.style.left = `${x - 50}px`;
                deleteNodeBtn.style.top = `${y}px`;
                deleteNodeBtn.style.display = "block"; // Allow deleting symbols
                addNodeBtn.style.display = "none";
                return;
            }

            addNodeBtn.style.left = `${x + 20}px`;
            addNodeBtn.style.top = `${y}px`;
            addNodeBtn.style.display = "block";

            if (!links.some(link => link.source === node.id)) {
                deleteNodeBtn.style.left = `${x - 50}px`;
                deleteNodeBtn.style.top = `${y}px`;
                deleteNodeBtn.style.display = "block";
            } else {
                deleteNodeBtn.style.display = "none";
            }
        }


        addNodeBtn.addEventListener("click", () => {
            if (selectedNode) {
                // Find the previous node in the connected line
                let prevNode = links.find(link => link.target === selectedNode.id);
                let inheritedText = prevNode ? nodes.find(n => n.id === prevNode.source)?.text : selectedNode.text;

                // Determine the new node's label
                let newNodeText = (selectedNode.text === "DTR") ? "8m" :
                    (selectedNode.text === "8m" || selectedNode.text === "9m" || selectedNode.text === "9m") ? selectedNode.text :
                        inheritedText || selectedNode.text; // Fallback to selectedNode.text if no previous node

                const newNode = {
                    id: nodes.length + 1,
                    x: selectedNode.x + 100,
                    y: selectedNode.y,
                    text: newNodeText,  // Apply the determined text
                    color: "gray"
                };

                nodes.push(newNode);
                links.push({ source: selectedNode.id, target: newNode.id, color: "black" });
                drawDiagram();
                hideButtons();
            }
        });


        deleteNodeBtn.addEventListener("click", () => {
            if (selectedNode) {
                nodes = nodes.filter(n => n.id !== selectedNode.id);
                links = links.filter(l => l.source !== selectedNode.id && l.target !== selectedNode.id);
                drawDiagram();
                hideButtons();
            }
        });

        function hideButtons() {
            addNodeBtn.style.display = "none";
            deleteNodeBtn.style.display = "none";
        }

        drawDiagram();
    </script>
    <script>
        function selectPageSizeAndOrientation() {
            const sizes = {
                "A4": [210, 297],
                "A3": [297, 420],
                "A5": [148, 210],
                "A2": [420, 594],
                "A1": [594, 841],
                "A0": [841, 1189]
            };

            // Fetch selected values from dropdowns
            const sizeChoice = document.getElementById("paperSize").value;
            const orientation = document.getElementById("orientation").value;

            let [width, height] = sizes[sizeChoice];
            if (orientation === "landscape") [width, height] = [height, width];

            return { width, height, orientation };
        }

        // Global variable to track if save is in progress
        let isSaveInProgress = false;

        function saveAsImage(format, width, height) {
            // Prevent multiple simultaneous saves
            if (isSaveInProgress) {
                console.log("Save operation already in progress, ignoring request");
                return;
            }

            isSaveInProgress = true;

            // Always use landscape orientation
            const orientation = "landscape";

            const container = document.querySelector(".container");
            const summaryTable = document.getElementById("summaryTable");
            container.appendChild(summaryTable); // Move summaryTable inside container


            // Get all the interface elements to hide
            const menuBtn = document.getElementById("menuBtn");
            const addTextBoxBtn = document.getElementById("addTextBox");
            const addNetworkBtn = document.getElementById("addNetworkBtn");
            const addSignatureBtn = document.getElementById("addSignatureBtn");
            const paperSizeLabel = document.querySelector("label[for='paperSize']");
            const paperSizeSelect = document.getElementById("paperSize");
            const orientationLabel = document.querySelector("label[for='orientation']");
            const orientationSelect = document.getElementById("orientation");
            const resetBtn = document.getElementById("resetBtn");
            const savePngBtn = document.getElementById("savePngBtn");
            const savePdfBtn = document.getElementById("savePdfBtn");
            const menuList = document.getElementById("menuList");
            const addNodeBtn = document.getElementById("addNodeBtn");
            const deleteNodeBtn = document.getElementById("deleteNodeBtn");
            const signatureInput = document.getElementById("signatureInput");
            const drawRoadBtn = document.getElementById("drawRoadBtn");


            // Store visibility states
            const elementsToHide = [
                menuBtn, addTextBoxBtn, addNetworkBtn, addSignatureBtn,
                paperSizeLabel, paperSizeSelect, orientationLabel, orientationSelect,
                resetBtn, savePngBtn, savePdfBtn, menuList, addNodeBtn, deleteNodeBtn, signatureInput, drawRoadBtn
            ];

            // Save original display states
            const originalDisplayStates = elementsToHide.map(el => el ? el.style.display : null);

            // Hide all buttons and controls
            elementsToHide.forEach(el => {
                if (el) el.style.display = "none";
            });

            // Temporarily move text boxes into the container
            const legendTable = document.getElementById("legendTable");
            const textBoxes = document.querySelectorAll(".text-box");
            const signatures = document.querySelectorAll('[id^="signature-"]');

            // Move elements into container for capture
            container.appendChild(legendTable);
            textBoxes.forEach(textBox => container.appendChild(textBox));
            signatures.forEach(sig => container.appendChild(sig));

            // Now capture the image
            html2canvas(container, { backgroundColor: "#ffffff", scale: 3 }).then(canvas => {
                try {
                    if (format === "png") {
                        const link = document.createElement("a");
                        link.href = canvas.toDataURL("image/png");
                        link.download = `diagram_${width}x${height}_landscape.png`;
                        document.body.appendChild(link); // Temporarily add to body
                        link.click();
                        document.body.removeChild(link); // Remove after clicking

                    } else if (format === "pdf") {
                        const { jsPDF } = window.jspdf;
                        const contentHeight = container.scrollHeight; // 🔥 Get actual content height

                        const pdf = new jsPDF({
                            orientation: "landscape",
                            unit: "px",
                            format: [canvas.width, contentHeight + 200] // 🔥 Use actual content height, not full canvas
                        });

                        const imgData = canvas.toDataURL("image/png");
                        const pdfWidth = pdf.internal.pageSize.getWidth();
                        const pdfHeight = (canvas.height * pdfWidth) / canvas.width; // Maintain aspect ratio

                        pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);

                        pdf.save(`diagram_${width}x${height}_landscape.pdf`);
                    }
                } finally {
                    // Restore everything after download regardless of format
                    restoreElements();

                    // Reset the save in progress flag
                    setTimeout(() => {
                        isSaveInProgress = false;
                    }, 500); // Add a small delay to prevent rapid double-clicks
                }
            });

            function restoreElements() {
                // Restore original display states
                elementsToHide.forEach((el, i) => {
                    if (el) el.style.display = originalDisplayStates[i];
                });

                // Move legend and text boxes back to body
                document.body.appendChild(legendTable);
                textBoxes.forEach(textBox => document.body.appendChild(textBox));
                signatures.forEach(sig => document.body.appendChild(sig));
            }
        }

        // Remove any existing event listeners first by replacing the buttons
        document.getElementById("savePdfBtn").outerHTML = document.getElementById("savePdfBtn").outerHTML;
        document.getElementById("savePngBtn").outerHTML = document.getElementById("savePngBtn").outerHTML;

        // Now add new event listeners
        /*     document.getElementById("savePdfBtn").addEventListener("click", function (event) {
                 event.preventDefault(); // Prevent default behavior
                 event.stopPropagation(); // Stop propagation to prevent bubbling
     
                 const { width, height } = selectPageSizeAndOrientation();
                 saveAsImage("pdf", width, height);
             });
     */

        savePdfBtn.outerHTML = savePdfBtn.outerHTML;

        // Re-select button and add a fresh event listener
        document.getElementById("savePdfBtn").addEventListener("click", function (event) {
            event.preventDefault();
            event.stopPropagation();

            const { width, height } = selectPageSizeAndOrientation();
            saveAsImage("pdf", width, height);
        });

        document.getElementById("savePngBtn").addEventListener("click", function (event) {
            event.preventDefault(); // Prevent default behavior
            event.stopPropagation(); // Stop propagation to prevent bubbling

            const { width, height } = selectPageSizeAndOrientation();
            saveAsImage("png", width, height);
        });

        // Modify selectPageSizeAndOrientation to always return landscape
        function selectPageSizeAndOrientation() {
            return {
                width: 297, // Default to A4 Landscape (Width x Height in mm)
                height: 210,
                orientation: "landscape"
            };
        }


        document.getElementById("addTextBox").addEventListener("click", () => {
            const textBox = document.createElement("div");
            textBox.className = "text-box";
            textBox.contentEditable = true;
            textBox.textContent = "Type here...";

            Object.assign(textBox.style, {
                position: "absolute",
                top: `${Math.random() * 400 + 50}px`, // Random position to prevent overlap
                left: `${Math.random() * 400 + 50}px`,
                background: "none",
                padding: "5px",
                border: "1px solid transparent", // Initially hidden
                cursor: "move",
                width: "150px",
                minHeight: "30px",
                overflow: "auto",
                outline: "none"
            });

            // Create a resize handle
            const resizeHandle = document.createElement("div");
            Object.assign(resizeHandle.style, {
                width: "10px",
                height: "10px",
                background: "black",
                position: "absolute",
                bottom: "0",
                right: "0",
                cursor: "se-resize",
                display: "none" // Initially hidden
            });

            // Create a delete button
            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-btn";
            deleteBtn.textContent = "Delete";
            Object.assign(deleteBtn.style, {
                position: "absolute",
                background: "red",
                color: "white",
                border: "none",
                padding: "5px",
                cursor: "pointer",
                display: "none",
                zIndex: "1000"
            });

            deleteBtn.addEventListener("click", () => {
                textBox.remove();
                deleteBtn.remove();
                document.querySelectorAll(".toolbar").forEach(el => el.remove());
            });

            textBox.appendChild(resizeHandle);
            document.body.appendChild(textBox);
            document.body.appendChild(deleteBtn);

            makeDraggable(textBox);
            makeResizable(textBox, resizeHandle);

            // Show toolbar, border, resize handle, and delete button on click
            textBox.addEventListener("click", (event) => {
                event.stopPropagation(); // Prevent hiding when clicking inside
                textBox.style.border = "1px solid black"; // Show border
                resizeHandle.style.display = "block"; // Show resize handle
                addToolbar(textBox);

                // Position and show delete button
                deleteBtn.style.left = `${parseInt(textBox.style.left) + parseInt(textBox.style.width) + 10}px`;
                deleteBtn.style.top = `${parseInt(textBox.style.top)}px`;
                deleteBtn.style.display = "block";
            });

            // Hide toolbar, border, resize handle, and delete button when clicking outside
            document.addEventListener("click", (event) => {
                if (!textBox.contains(event.target) && !document.querySelector(".toolbar")?.contains(event.target) && event.target !== deleteBtn) {
                    document.querySelectorAll(".toolbar").forEach(el => el.remove());
                    textBox.style.border = "1px solid transparent"; // Hide border
                    resizeHandle.style.display = "none"; // Hide resize handle
                    deleteBtn.style.display = "none"; // Hide delete button
                }
            });
        });




        // Function to make text box draggable
        function makeDraggable(element) {
            let offsetX, offsetY, isDragging = false;

            element.addEventListener("mousedown", (event) => {
                if (event.target !== element) return; // Prevent dragging while resizing
                isDragging = true;
                offsetX = event.clientX - element.getBoundingClientRect().left;
                offsetY = event.clientY - element.getBoundingClientRect().top;
                element.style.zIndex = 1000;
            });

            document.addEventListener("mousemove", (event) => {
                if (isDragging) {
                    element.style.left = event.clientX - offsetX + "px";
                    element.style.top = event.clientY - offsetY + "px";
                    moveToolbar(element);
                }
            });

            document.addEventListener("mouseup", () => {
                isDragging = false;
            });
        }

        // Function to make text box resizable
        function makeResizable(element, handle) {
            let isResizing = false;

            handle.addEventListener("mousedown", (event) => {
                isResizing = true;
                event.stopPropagation(); // Prevent triggering drag
            });

            document.addEventListener("mousemove", (event) => {
                if (isResizing) {
                    element.style.width = event.clientX - element.getBoundingClientRect().left + "px";
                    element.style.height = event.clientY - element.getBoundingClientRect().top + "px";
                    moveToolbar(element);
                }
            });

            document.addEventListener("mouseup", () => {
                isResizing = false;
            });
        }

        // Function to add text formatting toolbar (only appears on click)
        function addToolbar(textBox) {
            // Remove any existing toolbar
            document.querySelectorAll(".toolbar").forEach(el => el.remove());

            const toolbar = document.createElement("div");
            toolbar.className = "toolbar";

            Object.assign(toolbar.style, {
                position: "absolute",
                top: `${parseInt(textBox.style.top) - 35}px`,
                left: textBox.style.left,
                background: "#f0f0f0",
                padding: "5px",
                border: "1px solid black",
                display: "flex",
                gap: "5px"
            });

            // Create formatting buttons
            const boldBtn = createFormatButton("B", "bold");
            const italicBtn = createFormatButton("I", "italic");
            const underlineBtn = createFormatButton("U", "underline");
            const fontSizeBtn = createFontSizeDropdown();
            const alignBtn = createAlignDropdown();

            toolbar.appendChild(boldBtn);
            toolbar.appendChild(italicBtn);
            toolbar.appendChild(underlineBtn);
            toolbar.appendChild(fontSizeBtn);
            toolbar.appendChild(alignBtn);

            document.body.appendChild(toolbar);

            function createFormatButton(label, command) {
                const btn = document.createElement("button");
                btn.textContent = label;
                btn.style.padding = "5px";
                btn.style.cursor = "pointer";
                btn.style.border = "1px solid black";
                btn.style.background = "white";

                btn.addEventListener("click", () => {
                    document.execCommand(command, false, null);
                });

                return btn;
            }

            function createFontSizeDropdown() {
                const select = document.createElement("select");
                [12, 14, 16, 18, 20, 24, 28, 32].forEach(size => {
                    const option = document.createElement("option");
                    option.value = size;
                    option.textContent = size + "px";
                    select.appendChild(option);
                });

                select.addEventListener("change", () => {
                    document.execCommand("fontSize", false, "7");
                    document.querySelectorAll("font[size='7']").forEach(font => {
                        font.removeAttribute("size");
                        font.style.fontSize = select.value + "px";
                    });
                });

                return select;
            }

            function createAlignDropdown() {
                const select = document.createElement("select");
                [["Left", "left"], ["Center", "center"], ["Right", "right"]].forEach(([label, value]) => {
                    const option = document.createElement("option");
                    option.value = value;
                    option.textContent = label;
                    select.appendChild(option);
                });

                select.addEventListener("change", () => {
                    document.execCommand("justify" + select.value.charAt(0).toUpperCase() + select.value.slice(1));
                });

                return select;
            }

            // Hide toolbar when clicking outside of text box or toolbar
            setTimeout(() => {
                document.addEventListener("click", (event) => {
                    if (!toolbar.contains(event.target) && !textBox.contains(event.target)) {
                        toolbar.remove();
                    }
                });
            }, 100);
        }

        // Function to move toolbar when dragging/resizing
        function moveToolbar(textBox) {
            const toolbar = document.querySelector(".toolbar");
            if (toolbar) {
                toolbar.style.top = `${parseInt(textBox.style.top) - 35}px`;
                toolbar.style.left = textBox.style.left;
            }
        }

        // Attach event listeners AFTER defining the functions
        document.getElementById("savePngBtn").addEventListener("click", function () {
            const { width, height, orientation } = selectPageSizeAndOrientation();
            saveAsImage("png", width, height, orientation);
        });

        document.getElementById("savePdfBtn").addEventListener("click", function () {
            const container = document.querySelector(".container");
            const menuBtn = document.getElementById("menuBtn");
            const addTextBoxBtn = document.getElementById("addTextBox");

            // Hide buttons before capturing
            menuBtn.style.display = "none";
            addTextBoxBtn.style.display = "none";

            // Move text boxes into the container for capture
            const textBoxes = document.querySelectorAll(".text-box");
            textBoxes.forEach(textBox => container.appendChild(textBox));

            html2canvas(container, {
                backgroundColor: "#ffffff",
                scale: 3,
                scrollX: 0,
                scrollY: 0,
                width: container.scrollWidth,  // 🔥 Capture only content width
                height: container.scrollHeight // 🔥 Capture only content height
            }).then(canvas => {


                const imgData = canvas.toDataURL("image/png");
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = (canvas.height * pdfWidth) / canvas.width; // Maintain aspect ratio

                pdf.addImage(imgData, "PNG", 0, 0, pdfWidth, pdfHeight);
                pdf.save("diagram.pdf");

                // Restore buttons and text boxes after saving
                menuBtn.style.display = "block";
                addTextBoxBtn.style.display = "block";
                textBoxes.forEach(textBox => document.body.appendChild(textBox));
            });
        });



    </script>
    <script>
        // document.getElementById("addTextBox").addEventListener("click", () => {
        const textBox = document.createElement("div");
        textBox.className = "text-box";
        textBox.contentEditable = true;
        textBox.textContent = "Type here...";

        Object.assign(textBox.style, {
            position: "absolute",
            top: "100px",
            left: "100px",
            background: "white",
            padding: "5px",
            border: "1px solid black",
            cursor: "move",
            width: "150px",
            minHeight: "30px"
        });

        document.body.appendChild(textBox);
        makeDraggable(textBox);
    });

        function makeDraggable(element) {
            let offsetX, offsetY, isDragging = false;

            element.addEventListener("mousedown", (event) => {
                isDragging = true;
                offsetX = event.clientX - element.getBoundingClientRect().left;
                offsetY = event.clientY - element.getBoundingClientRect().top;
                element.style.zIndex = 1000;
            });

            document.addEventListener("mousemove", (event) => {
                if (isDragging) {
                    element.style.left = event.clientX - offsetX + "px";
                    element.style.top = event.clientY - offsetY + "px";
                }
            });

            document.addEventListener("mouseup", () => {
                isDragging = false;
            });
        }
    </script>
    <!-- Your existing content -->

 <div id="legendTable"
    
        style="position: absolute; bottom: 60px; left: 50px; background: none; padding: 10px; cursor: grab; display: inline-block; z-index: 1;">

        <h3 id="legendHeader" style="margin: 5; cursor: grab;">Legend</h3>
        <table style="border-collapse: collapse; text-align: left; width: auto;">
    
                <th>Text/Symbol⠀⠀</th>
                <th>Meaning</th>
            </tr>
                        <tr style="border-bottom: 1px solid gray;"></tr>
            <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
        onmouseout="this.querySelector('.hide-btn').style.display='none';">
        <td>
            <svg width="50" height="10" onclick="openColorPicker(this)" style="cursor: pointer;">
                <rect width="50" height="10" fill="grey" />
            </svg>
            <input type="color" style="display: none;" onchange="changeColor(this)"/>
        </td>
        <td contenteditable="true">Existing network (✒️)</td>
        <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
    </tr>
    <tr style="border-bottom: 1px solid gray;"></tr>
    <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
onmouseout="this.querySelector('.hide-btn').style.display='none';">
<td>
    <svg width="50" height="10" onclick="openColorPicker(this)" style="cursor: pointer;">
        <rect width="50" height="10" fill="red" />
    </svg>
    <input type="color" style="display: none;" onchange="changeColor(this)"/>
</td>
<td contenteditable="true">Proposed network (✒️)</td>
<td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
</tr>
<tr style="border-bottom: 1px solid gray;"></tr>
<tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
onmouseout="this.querySelector('.hide-btn').style.display='none';">
<td>
<svg width="50" height="10" onclick="openColorPicker(this)" style="cursor: pointer;">
    <rect width="50" height="10" fill="blue" />
</svg>
<input type="color" style="display: none;" onchange="changeColor(this)"/>
</td>
<td contenteditable="true">33kV/11kV/LT (✒️)</td>
<td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
</tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
    onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>DTR</td>
                <td>Transformer Structure</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>DP</td>
                <td>Double Pole Structure</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>TP</td>
                <td>Triple Pole Structure</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>4P</td>
                <td>Four Pole Structure</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>HP</td>
                <td>H Beam Pole</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>RP</td>
                <td>Rail Pole</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>E</td>
                <td>Earthing</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>S</td>
                <td>Stay Set</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>C</td>
                <td>Service Connection</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>X</td>
                <td>Extension of pole</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                onmouseout="this.querySelector('.hide-btn').style.display='none';">
                <td>8m</td>
                <td>8m Pole</td>
                <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                    onmouseout="this.querySelector('.hide-btn').style.display='none';">
                    <td>9m</td>
                    <td>9m Pole</td>
                    <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
                </tr>
            </tr>
        
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                    onmouseout="this.querySelector('.hide-btn').style.display='none';">
                    <td>
                        <svg width="50" height="10">
                            <line x1="5" y1="5" x2="45" y2="5" stroke="black" stroke-width="2"/>
                            <line x1="10" y1="0" x2="20" y2="10" stroke="black" stroke-width="2"/>
                            <line x1="20" y1="0" x2="10" y2="10" stroke="black" stroke-width="2"/>
                            <line x1="25" y1="0" x2="35" y2="10" stroke="black" stroke-width="2"/>
                            <line x1="35" y1="0" x2="25" y2="10" stroke="black" stroke-width="2"/>
                            <line x1="40" y1="0" x2="50" y2="10" stroke="black" stroke-width="2"/>
                            <line x1="50" y1="0" x2="40" y2="10" stroke="black" stroke-width="2"/>
                        </svg>
                    </td>
                    <td>Span with Cradle Guard</td>
                    <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
                </tr>
            </tr>
        
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                    onmouseout="this.querySelector('.hide-btn').style.display='none';">
                    <td>
                        <svg width="50" height="10">
                            <path d="M0,5 Q5,0 10,5 T20,5 T30,5 T40,5 T50,5 T60,5 T70,5 T80,5 T90,5 T100,5" stroke="black" fill="transparent" stroke-width="2"/>
                        </svg>
                    </td>
                    <td>AB Cable</td> 
                    <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
                    <tr style="border-bottom: 1px solid gray;">
                </tr>
            </tr>
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                    onmouseout="this.querySelector('.hide-btn').style.display='none';">
                    <td>
                        <svg width="50" height="10">
                            <line x1="5" y1="5" x2="45" y2="5" stroke="black" stroke-width="2"/>
                            <line x1="25" y1="0" x2="25" y2="10" stroke="black" stroke-width="2"/>
                        </svg>
                    </td>
                    <td>Single Phase LT</td>
                    <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
                </tr>
            </tr>
            
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                    onmouseout="this.querySelector('.hide-btn').style.display='none';">
                    <td>
                        <svg width="50" height="10">
                            <line x1="5" y1="5" x2="45" y2="5" stroke="black" stroke-width="2"/>
                            <line x1="15" y1="0" x2="15" y2="10" stroke="black" stroke-width="2"/>
                            <line x1="35" y1="0" x2="35" y2="10" stroke="black" stroke-width="2"/>
                        </svg>
                    </td>
                    <td>Two Phase LT</td>
                    <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
                </tr>
            </tr>
            
            <tr style="border-bottom: 1px solid gray;">
                <tr class="legend-row" onmouseover="this.querySelector('.hide-btn').style.display='inline';" 
                    onmouseout="this.querySelector('.hide-btn').style.display='none';">
                    <td>
                        <svg width="50" height="10">
                            <line x1="5" y1="5" x2="45" y2="5" stroke="black" stroke-width="2"/>
                            <line x1="10" y1="0" x2="10" y2="10" stroke="black" stroke-width="2"/>
                            <line x1="25" y1="0" x2="25" y2="10" stroke="black" stroke-width="2"/>
                            <line x1="40" y1="0" x2="40" y2="10" stroke="black" stroke-width="2"/>
                        </svg>
                    </td>
                    <td>Three Phase LT</td>
                    <td><button class="hide-btn" style="display: none;" onclick="hideRow(this)">❌</button></td>
                    <tr style="border-bottom: 1px solid gray;">
                </tr>
            </tr>
        </table>
    </div>

    <script>

         function openColorPicker(element) {
    let colorInput = element.nextElementSibling;
    colorInput.style.display = "block";
    colorInput.focus(); // Ensures the input is active
    colorInput.click();
}

function changeColor(input) {
    let svg = input.previousElementSibling;
    let rect = svg.querySelector("rect");
    rect.setAttribute("fill", input.value);
    input.style.display = "none"; // Hide after selection
}
// Function to enable dragging for a given table
function makeTableDraggable(tableId) {
    const table = document.getElementById(tableId);
    let isDragging = false, offsetX, offsetY;

    table.addEventListener("mousedown", (event) => {
        // Ignore clicks on the delete button
        if (event.target.classList.contains("delete-table-btn")) return;

        isDragging = true;
        table.style.cursor = "grabbing";
        offsetX = event.clientX - table.getBoundingClientRect().left;
        offsetY = event.clientY - table.getBoundingClientRect().top;
    });

    document.addEventListener("mousemove", (event) => {
        if (isDragging) {
            table.style.left = event.clientX - offsetX + "px";
            table.style.top = event.clientY - offsetY + "px";
        }
    });

    document.addEventListener("mouseup", () => {
        isDragging = false;
        table.style.cursor = "grab";
    });
}

// Store the default table HTML for resetting
const defaultSummaryHTML = document.getElementById("summaryTable").innerHTML;
const defaultLegendHTML = document.getElementById("legendTable").innerHTML;

// Function to toggle visibility of tables and reset content when showing
function toggleTableVisibility(tableId) {
    const table = document.getElementById(tableId);
    if (table.style.display === "none" || table.style.display === "") {
        // Restore default content when showing
        table.innerHTML = tableId === "summaryTable" ? defaultSummaryHTML : defaultLegendHTML;
        makeTableDraggable(tableId); // Reapply draggable behavior
        table.style.display = "block";
    } else {
        table.style.display = "none";
    }
}

// Function to delete (hide) the table
function deleteTable(tableId) {
    document.getElementById(tableId).style.display = "none";
}

// Function to hide a row when clicking the delete button
function hideRow(button) {
    button.closest("tr").style.display = "none";
}

// Apply the draggable functionality to both tables
makeTableDraggable("summaryTable");
makeTableDraggable("legendTable");

// Attach event listeners for toggling visibility
document.getElementById("legendBtn").addEventListener("click", () => toggleTableVisibility("legendTable"));
document.getElementById("summaryBtn").addEventListener("click", () => toggleTableVisibility("summaryTable"));
        

// Add Signature
        const signatureBtn = document.getElementById("addSignatureBtn");
        const signatureInput = document.getElementById("signatureInput");

        signatureBtn.addEventListener("click", () => {
            signatureInput.value = '';
            signatureInput.click();
        });

        signatureInput.addEventListener("change", (event) => {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    const fileType = file.type;
                    const signatureId = "signature-" + Date.now();

                    // Create a wrapper div for transformation
                    const container = document.createElement("div");
                    container.id = signatureId;
                    Object.assign(container.style, {
                        position: "absolute",
                        top: "200px",
                        left: "200px",
                        cursor: "move",
                        zIndex: "1000",
                        display: "inline-block",
                        transformOrigin: "center",
                        transform: "rotate(0deg)"
                    });

                    let contentElement;

                    if (fileType === "image/svg+xml") {
                        contentElement = document.createElement("object");
                        contentElement.type = "image/svg+xml";
                        contentElement.data = e.target.result;
                    } else if (fileType === "image/png") {
                        contentElement = document.createElement("img");
                        contentElement.src = e.target.result;
                    } else {
                        alert("Unsupported file type! Please upload PNG or SVG.");
                        return;
                    }

                    Object.assign(contentElement.style, {
                        width: "150px",
                        height: "150px",
                        pointerEvents: "none",
                        display: "block"
                    });

                    // Create delete button
                    const deleteBtn = document.createElement("button");
                    deleteBtn.textContent = "Delete";
                    Object.assign(deleteBtn.style, {
                        position: "absolute",
                        top: "-25px",
                        right: "0",
                        background: "red",
                        color: "white",
                        border: "none",
                        padding: "5px",
                        cursor: "pointer",
                        display: "none",
                        zIndex: "1001"
                    });
                    deleteBtn.addEventListener("click", () => container.remove());

                    // Create resize handle
                    const resizeHandle = document.createElement("div");
                    Object.assign(resizeHandle.style, {
                        position: "absolute",
                        width: "15px",
                        height: "15px",
                        background: "blue",
                        bottom: "-7px",
                        right: "-7px",
                        cursor: "se-resize",
                        display: "none",
                        zIndex: "1001"
                    });

                    // Create rotate handle
                    const rotateHandle = document.createElement("div");
                    Object.assign(rotateHandle.style, {
                        position: "absolute",
                        width: "15px",
                        height: "15px",
                        background: "green",
                        top: "-25px",
                        left: "50%",
                        transform: "translateX(-50%)",
                        cursor: "grab",
                        display: "none",
                        zIndex: "1001"
                    });

                    let hideControlsTimeout;
                    container.addEventListener("mouseenter", () => {
                        deleteBtn.style.display = "block";
                        resizeHandle.style.display = "block";
                        rotateHandle.style.display = "block";
                        clearTimeout(hideControlsTimeout);
                    });

                    container.addEventListener("mouseleave", () => {
                        hideControlsTimeout = setTimeout(() => {
                            deleteBtn.style.display = "none";
                            resizeHandle.style.display = "none";
                            rotateHandle.style.display = "none";
                        }, 1500);
                    });

                    // Dragging
                    let isDragging = false, startX, startY;
                    container.addEventListener("mousedown", function (e) {
                        if ([deleteBtn, resizeHandle, rotateHandle].includes(e.target)) return;
                        isDragging = true;
                        startX = e.clientX - container.offsetLeft;
                        startY = e.clientY - container.offsetTop;
                        function moveHandler(e) {
                            if (isDragging) {
                                container.style.left = `${e.clientX - startX}px`;
                                container.style.top = `${e.clientY - startY}px`;
                            }
                        }
                        function upHandler() {
                            isDragging = false;
                            document.removeEventListener("mousemove", moveHandler);
                            document.removeEventListener("mouseup", upHandler);
                        }
                        document.addEventListener("mousemove", moveHandler);
                        document.addEventListener("mouseup", upHandler);
                    });

                    // Resizing
                    let isResizing = false;
                    resizeHandle.addEventListener("mousedown", function (e) {
                        isResizing = true;
                        e.stopPropagation();
                        const startX = e.clientX, startY = e.clientY;
                        const startWidth = contentElement.offsetWidth, startHeight = contentElement.offsetHeight;
                        function resizeHandler(e) {
                            if (isResizing) {
                                const newWidth = startWidth + (e.clientX - startX);
                                const newHeight = startHeight + (e.clientY - startY);
                                if (newWidth > 50 && newHeight > 50) {
                                    contentElement.style.width = `${newWidth}px`;
                                    contentElement.style.height = `${newHeight}px`;
                                }
                            }
                        }
                        function stopResize() {
                            isResizing = false;
                            document.removeEventListener("mousemove", resizeHandler);
                            document.removeEventListener("mouseup", stopResize);
                        }
                        document.addEventListener("mousemove", resizeHandler);
                        document.addEventListener("mouseup", stopResize);
                    });

                    // Rotation
                    let isRotating = false;
                    rotateHandle.addEventListener("mousedown", function (e) {
                        isRotating = true;
                        e.stopPropagation();
                        const rect = container.getBoundingClientRect();
                        const centerX = rect.left + rect.width / 2;
                        const centerY = rect.top + rect.height / 2;
                        function rotateHandler(e) {
                            if (isRotating) {
                                const deltaX = e.clientX - centerX;
                                const deltaY = e.clientY - centerY;
                                const angle = Math.atan2(deltaY, deltaX) * (180 / Math.PI);
                                container.style.transform = `rotate(${angle}deg)`;
                            }
                        }
                        function stopRotate() {
                            isRotating = false;
                            document.removeEventListener("mousemove", rotateHandler);
                            document.removeEventListener("mouseup", stopRotate);
                        }
                        document.addEventListener("mousemove", rotateHandler);
                        document.addEventListener("mouseup", stopRotate);
                    });

                    // Append elements
                    container.appendChild(contentElement);
                    container.appendChild(deleteBtn);
                    container.appendChild(resizeHandle);
                    container.appendChild(rotateHandle);
                    document.querySelector(".container").appendChild(container);
                };
                reader.readAsDataURL(file);
            }
        });



        // Disable right click
        document.addEventListener('contextmenu', function (event) {
            event.preventDefault();
            alert('Right click is disabled on this page!');
        });

        // Disable keyboard shortcuts that could bypass right-click protection
        document.addEventListener('keydown', function (event) {
            // Prevent Ctrl+Shift+I (Inspector)
            // Prevent Ctrl+U (View Source)
            if (
                (event.ctrlKey && event.shiftKey && event.key === 'I') ||
                (event.ctrlKey && event.key === 'u')
            ) {
                event.preventDefault();
                alert('This action is disabled!');
            }
        });

      
    document.getElementById("exportJsonBtn").addEventListener("click", () => {
    const exportData = {
        nodes: nodes,
        links: links
    };
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: "application/json" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = "drawing.json";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
});

document.getElementById("importJsonBtn").addEventListener("click", () => {
    document.getElementById("importJsonInput").click();
});

document.getElementById("importJsonInput").addEventListener("change", function (event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            try {
                const importData = JSON.parse(e.target.result);
                nodes = importData.nodes || [];
                links = importData.links || [];
                drawDiagram(); // Refresh the drawing with imported data
            } catch (error) {
                alert("Invalid JSON file!");
            }
        };
        reader.readAsText(file);
    }
});
window.onload = function () {
    // Show popup when clicking the info button
    document.getElementById("infoBtn").addEventListener("click", function () {
        document.getElementById("infoPopup").style.display = "block";
    });

    // Close info popup when clicking "Not Now"
    document.getElementById("closePopupBtn").addEventListener("click", function () {
        document.getElementById("infoPopup").style.display = "none";
    });

    // Open Gmail in a new tab when clicking "Say Thank You"
    document.getElementById("thankYouBtn").addEventListener("click", function () {
        window.open(
            "https://mail.google.com/mail/?view=cm&fs=1&to=utility.dipankar@gmail.com&su=Thanks for the tool&body=I appreciate your work!", 
            "_blank"
        );
    });

    // Show the User Guide Popup when clicking "View User Guide"
    document.getElementById("openUserGuide").addEventListener("click", function (event) {
        event.preventDefault(); // Prevent default link behavior
        document.getElementById("userGuidePopup").style.display = "block";
    });

    // Close the User Guide Popup
    document.getElementById("closeUserGuide").addEventListener("click", function () {
        document.getElementById("userGuidePopup").style.display = "none";
    });
};


    </script>
    
<div id="infoPopup" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
    background: white; padding: 20px; box-shadow: 0px 4px 10px rgba(0,0,0,0.3); z-index: 1000; border-radius: 10px; 
    text-align: center; width: 400px;">
    <p>Created to draw not-to-scale SLD for electric distribution network.<br>Say thank you, if you like to use.</p>
    
    <!-- Button to open the User Guide inside a bigger popup -->
    <p><a href="#" id="openUserGuide" style="color: blue; text-decoration: underline;">View User Guide</a></p>
    
    <button id="thankYouBtn" style="margin-right: 10px;">Say Thank You</button>
    <button id="closePopupBtn">Not Now</button>
</div>
    <div id="userGuidePopup" style="display: none; position: fixed; top: 5%; left: 50%; transform: translate(-50%, 0%);
    background: white; padding: 20px; box-shadow: 0px 4px 10px rgba(0,0,0,0.3); z-index: 1001; border-radius: 10px; 
    width: 80%; height: 80%; overflow-y: auto;">
    <head>
        <title>SLD Drawing Tool - User Guide</title>
        <style>
            body {
                font-family: Arial, sans-serif;
            }
            .important-message {
                text-align: center;
                font-weight: bold;
                color: red;
                margin-top: 30px;
            }
        </style>
    </head>
    <body>
        <h2>SLD Drawing Tool - User Guide</h2>
        <p>The <strong>SLD Drawing Tool</strong> is designed to create <strong>not-to-scale</strong> Single Line Diagrams (SLD) for electrical distribution networks.</p>    
        <h3>Editing and Customizing Poles</h3>
        <ul>
            <li><strong>Drag a pole:</strong> To select and move it anywhere on the canvas.</li>
            <li><strong>Click on a pole:</strong> To view "Add" and "Delete" options.</li>
            <li><strong>Click on text inside pole:</strong> Edit text, 8m, 9m DP, etc.</li>
            <li><strong>Click on text (E, S) below pole:</strong> Edit like 1E, 2S to mean 1 earthing, 2 Stay Set.</li>
            <li><strong>Double-click a pole:</strong> To change the color of a pole to differentiate existing and proposed poles. Use the color picker to make poles the same color.</li>
        </ul>
        <h3>Editing and Customizing Lines</h3>
        <ul>
            <li><strong>Click on text 'Label' on a line:</strong> Edit label, like 45m to mean span length or enter feeder name.</li>
            <li><strong> One click on a line:</strong> To change the style of the line from solid to AB Cable / Any Cable.</li>
            <li><strong>Two click on a line:</strong> To change the style of the line from AB Cable / Any Cable to span with CG.</li>
            <li><strong>Three click on a line:</strong> To change the style of the line from span with CG to sigle phase LT-line.</li>
            <li><strong>Four click on a line:</strong> To change the style of the line from sigle phase LT-line to two phase LT-line.</li>
            <li><strong>Five click on a line:</strong> To change the style of the line from two phase LT-line to three phase LT-line.</li>
            <li><strong>Double-click on a line:</strong> To change the color of the line.</li>
        </ul>
        <h3>Adding Other Elements to the SLD</h3>
        <ul>
            <li><strong>Add Text Box:</strong> Allows adding text annotations to create descriptions, custom legends, etc.</li>
            <li><strong>Add Symbol:</strong> Allows adding some landmarks with symbols.</li>
            <li><strong>Add New Network:</strong> Add a new isolated pole on the canvas, which can be extended to a new network by adding new poles by clicking on it.</li>
            <li><strong>Add Signature:</strong> Add a resizable, rotatable, movable .png or .svg image for scanned signatures or custom landmarks.</li>
            <li><strong>Draw Road:</strong> Select color, size (width of road), opacity, then click on the canvas to draw the road. Click "Stop Road" to end drawing.</li>
        </ul>
        <h3>Importing / Exporting SLD</h3>
        <ul>
            <li><strong>Import SLD:</strong> Allows uploading diagrams as JSON.</li>
            <li><strong>Export SLD:</strong> Allows exporting diagrams as JSON.</li>
        </ul>
        <h3>Resetting Everything</h3>
        <ul>
            <li><strong>Reset:</strong> Refresh to the default page.</li>
        </ul>   
        <h3>Downloading Final Result in PDF/PNG</h3>
        <ul>
            <li><strong>⤓ PNG:</strong> Download the diagram in landscape orientation in PNG format.</li>
            <li><strong>⤓ PDF:</strong> Download the diagram in landscape orientation in PDF format.</li>
        </ul>
        <h3>Legend and Summary</h3>
        <ul>
            <li><strong>The legend table is movable. Click Ⓛ icon at the top to hide/unhide the table.</strong></li>
            <li><strong>Select different colours and write descritiptions in first 3rows of legend table for different purpose.</strong></li>
            <li><strong>The summary table is editable & movable.Click Ⓢ icon at the top to hide/unhide the table.</strong></li>
            <li><strong>Delete any row of Legend / Summary table which is not required.</strong></li>

        </ul>
        <h3>Contact & Support</h3>
        <p>For questions or feedback, contact <a href="mailto:utility.dipankar@gmail.com">utility.dipankar@gmail.com</a>.</p> 
        <p class="important-message">REDUCE USE OF PEN-PAPER TO CREATE / SHARE SLD. GREENER EARTH IS A COMMITMENT TO OUR FUTURE GENERATION.</p>
    </body>  
    <!-- Close Button at the Bottom -->
    <button id="closeUserGuide" style="margin-top: 20px; display: block; width: 100px; margin-left: auto; margin-right: auto;">OK</button>
</div>
</body>
</html>
</body>
</html>
